<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agendar Cita</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Tu CSS -->
  <link rel="stylesheet" th:href="@{/css/styles.css}" />
</head>
<body class="bg-page">

  <!-- Header -->
  <header class="bg-mep text-white py-2 shadow-sm">
    <div class="container d-flex align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-3">
        <img th:src="@{/img/mep-logo.png}" alt="MEP" height="36" />
        <h1 class="h6 m-0 fw-semibold">MEP - Matrículas y Educación Pública</h1>
      </div>
      <a th:href="@{/logout}" class="btn btn-warning btn-sm fw-semibold">Cerrar sesión</a>
    </div>
  </header>

  <!-- Subnav -->
  <nav class="bg-mep-700 text-white">
    <div class="container d-flex gap-4 py-2 small">
      <a class="nav-link-lite" th:href="@{/faq}">Preguntas Frecuentes</a>
      <a class="nav-link-lite" th:href="@{/ayuda}">Ayuda</a>
      <a class="nav-link-lite" th:href="@{/contacto}">Contáctanos</a>
    </div>
  </nav>

  <!-- Contenido -->
  <main class="container my-4">
    <h1 class="text-center">Agendar una cita</h1>

    <!-- PASO 1 -->
    <form th:action="@{/tutor/agendar-cita}" method="get" class="mt-3">
      <div class="mb-3">
        <label for="localidad" class="form-label fw-semibold">Localidad de Bogotá</label>
        <select name="localidad" id="localidad" class="form-select" required>
          <option value="" disabled th:selected="${selectedLocalidad == null}">Seleccione</option>
          <option th:each="loc : ${localidades}" th:text="${loc}" th:value="${loc}"
                  th:selected="${loc == selectedLocalidad}"></option>
        </select>
      </div>

      <div class="row g-2">
        <button type="submit" class="btn btn-success w-100">Seleccionar</button>
      </div>
    </form>

    <!-- PASO 2 -->
    <div th:if="${instituciones != null}" class="mt-4">
      <form th:action="@{/tutor/agendar-cita}" method="post" id="agendarForm" novalidate>
        <div class="mb-3">
          <label for="institucionId" class="form-label fw-semibold">Institución</label>
          <select id="institucionId" name="institucionId" class="form-select" required>
            <option value="" disabled selected>Seleccione</option>
            <option th:each="inst : ${instituciones}" th:value="${inst.id}" th:text="${inst.nombre}"></option>
          </select>
        </div>

        <div class="mb-3">
          <label for="grado" class="form-label fw-semibold">Grado académico</label>
          <select id="grado" name="grado" class="form-select" required>
            <option value="" disabled selected>Seleccione</option>
            <option th:each="g : ${grados}" th:value="${g}" th:text="${g}"></option>
          </select>
        </div>

        <div class="mb-3">
          <label for="cantidad" class="form-label fw-semibold">Cantidad de personas</label>
          <input type="number" id="cantidad" name="cantidad" class="form-control" min="1" required>
        </div>

        <!-- Fecha: solo días hábiles y no permite hoy/anteriores -->
        <div class="mb-3">
          <label for="fecha" class="form-label fw-semibold">Fecha de la cita</label>
          <input type="date" id="fecha" name="fecha" class="form-control" required>
          <div class="form-text">Solo lunes a viernes. No se permite agendar para hoy ni días pasados.</div>
        </div>

        <!-- Hora: slots de 15 min entre 7:00 AM y 3:00 PM -->
        <div class="mb-3">
          <label for="horaSlot" class="form-label fw-semibold">Hora de la cita</label>
          <select id="horaSlot" class="form-select" required>
            <option value="" disabled selected>Seleccione hora</option>
            <!-- opciones se generan por JS -->
          </select>
          <!-- Valor que se envía al servidor en formato HH:mm -->
          <input type="hidden" id="hora" name="hora" required>
          <div class="form-text">Horario disponible: 7:00 AM a 3:00 PM, cada 15 minutos.</div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <button type="submit" class="btn btn-success w-100">Continuar</button>
          </div>
          <div class="col-6">
            <a class="btn btn-outline-secondary w-100" th:href="@{/tutor/dashboard}">Cancelar</a>
          </div>
        </div>
      </form>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ====== utilidades de fecha ======
    function toYMD(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function isWeekend(d) {
      const dow = d.getDay(); // 0=Dom, 6=Sáb
      return dow === 0 || dow === 6;
    }
    function nextBusinessDay(from) {
      // mínimo: siguiente día hábil (no hoy)
      const d = new Date(from.getFullYear(), from.getMonth(), from.getDate());
      d.setDate(d.getDate() + 1); // no permite mismo día
      while (isWeekend(d)) d.setDate(d.getDate() + 1);
      return d;
    }

    // ====== configurar fecha ======
    (function configureDatePicker(){
      const fechaInput = document.getElementById('fecha');
      if (!fechaInput) return;

      const min = nextBusinessDay(new Date());
      fechaInput.min = toYMD(min);

      fechaInput.addEventListener('input', () => {
        if (!fechaInput.value) return;
        const d = new Date(fechaInput.value + 'T00:00:00');
        // Validar que no sea fin de semana ni menor al mínimo
        let msg = '';
        if (isWeekend(d)) {
          msg = 'Solo se puede agendar de lunes a viernes.';
        } else if (d < min) {
          msg = 'No se puede agendar para hoy ni días anteriores.';
        }
        fechaInput.setCustomValidity(msg);
        if (msg) {
          fechaInput.reportValidity();
          fechaInput.value = ''; // limpiar selección inválida
        }
      });
    })();

    // ====== generar slots de hora ======
    (function configureTimeSlots(){
      const slotSel = document.getElementById('horaSlot');
      const hidden = document.getElementById('hora');
      if (!slotSel || !hidden) return;

      // Generar desde 07:00 hasta 15:00 inclusive, cada 15 min
      for (let h = 7; h <= 15; h++) {
        for (let m = 0; m < 60; m += 15) {
          if (h === 15 && m > 0) break; // a partir de 15:15 ya no
          const hh = String(h).padStart(2,'0');
          const mm = String(m).padStart(2,'0');
          const value24 = `${hh}:${mm}`;
          // Etiqueta en 12h
          const isPM = h >= 12;
          let h12 = h % 12; if (h12 === 0) h12 = 12;
          const label = `${h12}:${mm} ${isPM ? 'PM' : 'AM'}`;
          const opt = document.createElement('option');
          opt.value = value24;
          opt.textContent = label;
          slotSel.appendChild(opt);
        }
      }

      // Copiar al hidden para enviar HH:mm al servidor
      slotSel.addEventListener('change', () => {
        hidden.value = slotSel.value || '';
      });

      // Validar en submit
      const form = document.getElementById('agendarForm');
      if (form) {
        form.addEventListener('submit', (e) => {
          if (!slotSel.value) {
            e.preventDefault();
            slotSel.reportValidity();
            return;
          }
          hidden.value = slotSel.value;
        });
      }
    })();
  </script>
</body>
</html>
